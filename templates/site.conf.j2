#{{ ansible_managed }}

{% if nginx_sites[item]['upstream_group'] is defined %}
upstream {{ nginx_sites[item]['upstream_group']['name'] }} {
{% for number in range(0, nginx_sites[item]['upstream_group']['size']|int) %}
  {{ nginx_sites[item]['upstream_group']['base_string'].replace('$#', number|string) }}
{% endfor %}
}
{% endif %}

{% if nginx_sites[item]['upstream'] is defined %}
{% for name, conf in nginx_sites[item]['upstream'].iteritems() %}
upstream {{ name }} {
  {{ conf.replace(";",";\n      ") }}
}
{% endfor %}

{% endif %}
server {
{% for v in nginx_sites[item]['server'] %}
{% if v.find('\n') != -1 %}
  {{v.replace("\n","\n   ")}}
{% else %}
  {% if v != "" %}{{ v.replace(";",";\n    ").replace(" {"," {\n    ").replace(" }"," \n   }\n") }}{% if v.find('{') == -1%};
{% endif %}{% endif %}{% endif %}
{% endfor %}
}
